//UPX and MPress share common way when you wish to unpack a malware. However, there are exisiting tools which can be used to directly unpack the sample. This is just a documentation to understand the manual approach whenever a malware is getting unpacked

For manual unpacking of a UPX or an MPRESS packed file, we can follow the generic approach of putting a hardware breakpoint at the first 4 bytes present in ESP. Now, lets get into details, how we achieve that. 

To derive the unpacked file out of the packed file, we open the file in x32dbg and run it. So, it stops at the entrypoint (pushed). 
 

We do step-over which stops at the next call function. And we look at the ESP. We dump the contents of the ESP.
Actually in cases of UPX and MPress packed file, the entire content of the unpacked file is stored in the ESP(Extended Stack Pointer) before loading it in the memory. Our aim is the extract the unpacked file before it gets loaded into actual memory address.
 

After dumping the content, we select the first 4 bytes of the content from the dump and set a hardware breakpoint to it. 
After setting the hardware breakpoint, we run the code again to reach the breakpoint. Here, we look for the Original Entry Point(OEP), and this address marks the beginning of the unpacked file. 
 
We step-into the next jmp instruction that we see, and that address is the Original Entry Point(OEP). We use this address to dump into a folder using Scylla, and we can analyse the file further.
Also the “Add” instruction above confirms the addition of the unpacked file into the addresses that have been defined in the code. 

We enter the address of the Original EntryPoint in Scylla and click on IAT Autosearch.
It gives us the following result, after which we click on the get imports option. 
 
We now click on Dump to dump the extracted unpacked file into our chosen folder. We also click on fix Dump to make sure the alignment of all virtual addresses is correct.
We can see that an exe file is getting dumped into the folder.
 
On fixing the dump, we see that the exe file has SCY within the file name.

